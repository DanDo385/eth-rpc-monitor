# Ethereum RPC Monitor — Cursor Rules

## Project Context
Lightweight RPC endpoint monitor and block inspector for Ethereum.
Target: Portfolio project demonstrating Go proficiency, understanding of Ethereum JSON-RPC, and infrastructure thinking for institutional crypto roles.

## What This Project Is
- CLI tool monitoring RPC endpoint health, latency, and consistency
- Simple block inspector for verifying RPC responses
- Demonstrates operational awareness (latency matters for trading)

## What This Project Is NOT
- A geth/go-ethereum wrapper (we use raw HTTP)
- A trading bot or DeFi tool
- A web dashboard
- A wallet or signing tool

## Tech Stack
- Go 1.21+
- Dependencies (minimal):
  - `github.com/spf13/cobra` (CLI)
  - `gopkg.in/yaml.v3` (config)
  - `golang.org/x/sync/errgroup` (concurrent provider calls)
- Raw `net/http` for RPC (need latency visibility)
- **NO** `go-ethereum` packages

## Architecture
```
cmd/
├── block/
│   └── main.go   # Block inspector (fetch and display blocks)
├── compare/
│   └── main.go   # Cross-provider comparison
├── health/
│   └── main.go   # Provider health check
└── watch/
    └── main.go   # Continuous monitoring

internal/
├── config/
│   └── config.go # YAML loading, env var expansion
└── rpc/
    ├── client.go # HTTP client with optional retry
    └── types.go  # Block, Request, Response structs + hex parsing
    
config/
└── providers.yaml # Single source of truth for all config
```

## Commands
| Command | Description |
|---------|-------------|
| `block [block]` | Inspect block (default: latest, auto-selects fastest provider) |
| `health` | Test all providers, show latency stats |
| `compare [block]` | Fetch same block from all providers, detect mismatches |
| `watch` | Continuous monitoring with refresh interval |

## Configuration

### Single Source of Truth
All defaults live in `config/providers.yaml`. Go code inherits from YAML, never invents fallbacks.
```yaml
defaults:
  timeout: 10s
  max_retries: 3  # Set to 0 for no retry

providers:
  - name: alchemy
    url: ${ALCHEMY_URL}
    type: paid
  - name: ankr
    url: https://rpc.ankr.com/eth
    type: free
```

### Environment Variables
URLs can use `${VAR}` syntax. Expanded at load time via `os.ExpandEnv()`.

## RPC Client Design

### JSON for Wire Protocol (Required)
Ethereum JSON-RPC requires JSON. The `json` struct tags in `types.go` are for the wire protocol, not config.

### Retry Policy (Configurable)
- `max_retries: 0` = fail immediately
- `max_retries: 3` = retry up to 3 times with exponential backoff
- No circuit breaker (removed for simplicity)

### Methods Needed
- `eth_blockNumber` - current height
- `eth_getBlockByNumber` - block details

## Output Modes

### Terminal (Default)
Human-readable with formatting. Example:
```
Block #19,234,567
═══════════════════════════════════════════════════
  Hash:         0xabcd1234...
  Timestamp:    2024-01-15 14:23:11 UTC (2m ago)
  Gas:          12,456,789 / 30,000,000 (41.5%)
  Transactions: 143

  Provider:     alchemy (23ms)
```

### JSON (`--json` flag)
Machine-readable. No colors, no formatting, pipe-friendly.
```bash
./block latest --json | jq '.hash'
```

## Code Patterns

### Provider Selection
Race all providers, return first successful response:
```go
resultCh := make(chan result, len(providers))
for _, p := range providers {
    go func(p Provider) {
        // try provider, send to channel if success
    }(p)
}
// Return first result from channel
```

### Error Handling
- Wrap errors: `fmt.Errorf("context: %w", err)`
- Return up the stack, let Cobra display
- In JSON mode, errors to stderr only

### Hex Parsing
All Ethereum values are hex. Parse with:
```go
func ParseHexUint64(hex string) (uint64, error) {
    hex = strings.TrimPrefix(hex, "0x")
    val := new(big.Int)
    val.SetString(hex, 16)
    return val.Uint64(), nil
}
```

## Do NOT
- Use `go-ethereum` or `ethclient`
- Add web UI or persistence
- Hardcode config values in Go (use YAML)
- Mix stdout/stderr in JSON mode
- Compare block hashes from different heights

## Testing After Every Change
```bash
go build -o block ./cmd/block
go build -o compare ./cmd/compare
go build -o health ./cmd/health
go build -o watch ./cmd/watch
./block latest
./block latest --json | jq .
./health
./compare
./watch
```